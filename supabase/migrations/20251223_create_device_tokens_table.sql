-- Create device_tokens table\nCREATE TABLE IF NOT EXISTS public.device_tokens (\n  id uuid DEFAULT uuid_generate_v4 () PRIMARY KEY,\n  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  token text NOT NULL,\n  platform text CHECK (platform IN ('ios', 'android')) NOT NULL,\n  created_at timestamp with time zone DEFAULT now() NOT NULL,\n  updated_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n-- Enable RLS\nALTER TABLE public.device_tokens ENABLE ROW LEVEL SECURITY;\n\n-- Policies\nCREATE POLICY \"Users can manage their own device tokens\"\nON public.device_tokens\nFOR ALL\nUSING (auth.uid() = user_id)\nWITH CHECK (auth.uid() = user_id);\n\n-- Unique index to prevent duplicate tokens per user\nCREATE UNIQUE INDEX IF NOT EXISTS device_tokens_user_token_unique\nON public.device_tokens (user_id, token);\n\n-- Trigger for updated_at\nCREATE OR REPLACE FUNCTION update_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n   NEW.updated_at = now();\n   RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\nCREATE OR REPLACE TRIGGER device_tokens_update_timestamp\nBEFORE UPDATE ON public.device_tokens\nFOR EACH ROW EXECUTE PROCEDURE update_updated_at();\n